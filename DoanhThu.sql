SELECT * FROM HoaDon
UPDATE HoaDon SET TRANGTHAI =2 WHERE ID='14E1863B-9ECA-4CF0-BB7F-4FA5DE804B1F'
UPDATE HOADON SET THANHTIEN=(SELECT SUM(DONGIA*SOLUONG) FROM ChiTietHoaDon WHERE IDHD='6108264C-5E64-4395-B945-F91B42E90593')  WHERE ID='6108264C-5E64-4395-B945-F91B42E90593'
SELECT * FROM HOADON WHERE DAY(NgayTao)=DAY(GETDATE()) AND TrangThai=2
ALTER FUNCTION FNDTNGAY(@ngay DATE)
RETURNS @dtngay TABLE (doanhthu Decimal,thanhcong int,bihuy int)
AS
begin
DECLARE @dt decimal=0,@tc int=0,@bihuy int=0;
 SELECT @dt=SUM(THANHTIEN) FROM HOADON WHERE year(NgayMua)=year(@ngay) AND TRANGTHAI=1
 SELECT @tc= COUNT(MAHD) FROM HOADON WHERE year(NgayMua)=year(@ngay) AND TRANGTHAI=1
 SELECT @bihuy=  COUNT( MAHD ) FROM HOADON WHERE year(NGAYTAO)=year(@ngay) AND TRANGTHAI=2
INSERT INTO @dtngay VALUES(@dt,@tc,@bihuy)
RETURN
end
select * from khuyenmai
SELECT COUNT(MAHD) FROM HOADON WHERE TRANGTHAI=1 
SELECT * FROM dbo.FNDTTHANG(GETDATE())
SELECT SUM(ThanhTien)AS DT,(SELECT COUNT(MAHD)FROM HOADON WHERE TRANGTHAI=1) AS SODON FROM HoaDon 
GROUP BY THANHTIEN,MAHD
SELECT COUNT(MAHD) FROM HOADON
SELECT * FROM HOADON
UPDATE HOADON SET NgayTao='2022-02-03' WHERE MaHD='HD3'
CREATE PROC SP_DTTHANG @NAM int
as
begin
SELECT MONTH(ngaytao) as [year], COUNT(MAHD) AS SODON,SUM(ThanhTien) AS DoanhThu FROM HOADON where trangthai=1 AND YEAR(NGAYTAO)=@NAM  group by MONTH(ngaytao)
end
EXEC SP_DTNGAY 4,2023
SELECT MONTH(ngaytao) as [year], COUNT(MAHD) AS SODON,SUM(ThanhTien) AS DoanhThu FROM HOADON where trangthai=1 AND YEAR(NGAYTAO)=2023  group by MONTH(ngaytao)

SELECT DISTINCT Month(NGAYTAO) as [YEAR] FROM HOADON WHERE NGAYTAO IS NOT NULL ORDER BY [YEAR] DESC
select * from ChiTietSanPham
SELECT * FROM KhachHang
delete FROM ChiTietHoaDon where idctsp='D6718367-AE49-402F-9FC4-A2AE23D498B2'
SELECT * from khuyenmai
delete from ChiTietSanPham where id='D6718367-AE49-402F-9FC4-A2AE23D498B2'
select * from chitietsanpham
select * from ChiTietHoaDon
SELECT * FROM dbo.FNDTNGAY(getdate())
SELECT * FROM HOADON


ALTER TRIGGER SoLuong ON CHITIETSANPHAM AFTER UPDATE AS
BEGIN
	IF (SELECT INSERTED.SOLUONG FROM CHITIETSANPHAM JOIN INSERTED ON CHITIETSANPHAM.ID=INSERTED.ID)>0
	BEGIN
	UPDATE CHITIETSANPHAM SET TRANGTHAI=1 FROM CHITIETSANPHAM JOIN INSERTED ON CHITIETSANPHAM.ID=INSERTED.ID
	END
END
select * from GIAOHANG
CREATE TRIGGER HUYKHUYENMAI ON KHUYENMAI AFTER UPDATE AS
BEGIN
	IF(SELECT INSERTED.TRANGTHAI FROM KHUYENMAI JOIN INSERTED ON KHUYENMAI.ID=INSERTED.ID)=1
	BEGIN
	UPDATE CHITIETSANPHAM SET IDKM=NULL FROM CHITIETSANPHAM JOIN INSERTED ON CHITIETSANPHAM.IDKM=INSERTED.ID
	END
END
SELECT MAKH,TENKH,SDT,NGAYMUA,SUM(THANHTIEN) FROM KHACHHANG JOIN HOADON ON KHACHHANG.ID=HOADON.IDKH GROUP BY MAKH,TENKH,SDT,NGAYMUA,THANHTIEN
UPDATE HOADON SET TRANGTHAI=0 WHERE MaHD='HD5'
UPDATE KHACHHANG SET NGAYTHAMGIA='2023-04-02' WHERE MAKH='KH01'
SELECT Month(ngaytao)as [month], COUNT(MAHD) AS SODON,SUM(ThanhTien) AS DoanhThu FROM HOADON where trangthai=1 and year(ngaytao)=2023 group by month(ngaytao)
SELECT * FROM GiaoHang

SELECT dbo.ChatLieu.Ten, dbo.ChiTietHoaDon.SoLuong, dbo.ChiTietHoaDon.DonGia, dbo.ChiTietHoaDon.NgayBan, dbo.DanhMuc.Ten AS DanhMuc,
dbo.DoCao.Ten AS DoCao, dbo.HoaDon.MaHD, IIF(dbo.HOADON.IDKH IS NULL,N'Khách Lẻ',dboKhachHang.tenKH)AS TENKHACHHANG, 
dbo.MauSac.Ten AS MauSac, dbo.NhanVien.HoTen, dbo.SanPham.Ten AS SanPham, dbo.Size.Ten AS Size, dbo.ChiTietSanPham.GiaBan,
dbo.HoaDon.ThanhTien, (dbo.ChiTietHoaDon.SoLuong*dbo.ChiTietHoaDon.DonGia) AS Gia
FROM     dbo.HoaDon LEFT JOIN KHACHHANG ON HOADON.IDKH=KHACHHANG.ID INNER JOIN
                  dbo.ChiTietHoaDon ON dbo.HoaDon.Id = dbo.ChiTietHoaDon.IDHD INNER JOIN 
				  CHITIETSANPHAM ON CHITIETHOADON.IDCTSP=CHITIETSANPHAM.ID 
				  INNER JOIN
                  dbo.ChatLieu ON dbo.ChatLieu.Id = dbo.ChiTietSanPham.ChatLieu  INNER JOIN
                  dbo.DanhMuc ON dbo.ChiTietSanPham.DanhMuc = dbo.DanhMuc.Id INNER JOIN
                  dbo.DoCao ON dbo.ChiTietSanPham.DoCao = dbo.DoCao.Id INNER JOIN
                  dbo.MauSac ON dbo.ChiTietSanPham.MauSac = dbo.MauSac.Id INNER JOIN
                  dbo.NhanVien ON dbo.HoaDon.IDNV = dbo.NhanVien.Id INNER JOIN
                  dbo.SanPham ON dbo.ChiTietSanPham.IDSP = dbo.SanPham.Id INNER JOIN
                  dbo.Size ON dbo.ChiTietSanPham.Size = dbo.Size.Id

 WHERE MAHD='HD5'
alter table giaohang add ghichu nvarchar(200)
SELECT * FROM KHACHHANG
select * from HoaDon
select CHITIETHOADON.IDCTSP from ChiTietHoaDon JOIN HOADON ON HOADON.ID=ChiTietHoaDon.IDHD WHERE HOADON.TRANGTHAI=1


SELECT * FROM ChiTietSanPham
SELECT ChiTietSanPham.QR,S.TEN,SIZE.TEN,DOCAO.TEN,MAUSAC.TEN,DANHMUC.TEN,CHATLIEU.TEN,SUM(ChiTietHoaDon.SoLuong)AS SOLUONG
FROM CHITIETHOADON JOIN ChiTietSanPham ON ChiTietHoaDon.IDCTSP=ChiTietSanPham.ID 
JOIN HOADON ON HOADON.ID=ChiTietHoaDon.IDHD 
JOIN SANPHAM AS S ON S.ID=CHITIETSANPHAM.IDSP
JOIN SIZE ON SIZE.ID=ChiTietSanPham.Size
JOIN MAUSAC ON MAUSAC.ID=ChiTietSanPham.MauSac
JOIN DOCAO ON DOCAO.ID=ChiTietSanPham.DoCao
JOIN CHATLIEU ON CHATLIEU.ID=ChiTietSanPham.ChatLieu
JOIN DANHMUC ON DANHMUC.ID=ChiTietSanPham.DanhMuc
WHERE HOADON.TRANGTHAI=1   GROUP BY S.TEN,SIZE.TEN,MAUSAC.TEN,DOCAO.TEN,CHATLIEU.TEN,DANHMUC.TEN,QR
SELECT ChiTietHoaDon.ID,ChiTietSanPham.QR,ChiTietHoaDon.SoLuong FROM ChiTietHoaDon JOIN ChiTietSanPham ON CHITIETHOADON.IDCTSP=ChiTietSanPham.ID JOIN HOADON ON HOADON.ID=ChiTietHoaDon.IDHD
WHERE HOADON.TRANGTHAI=1
select * from ChiTietSanPham

SELECT  DANHMUC.TEN,SUM(CHITIETHOADON.SOLUONG) AS SL FROM CHITIETHOADON JOIN CHITIETSANPHAM AS CTSP 
ON CTSP.ID=ChiTietHoaDon.IDCTSP JOIN DanhMuc ON DANHMUC.ID=CTSP.DanhMuc
JOIN HOADON ON ChiTietHoaDon.IDHD=HoaDon.ID
WHERE HOADON.TRANGTHAI=1
GROUP BY DANHMUC.TEN



SELECT DANHMUC.TEN, COUNT(ChiTietSanPham.ID) AS SLBAN
FROM ChiTietSanPham JOIN DanhMuc ON DANHMUC.ID=ChiTietSanPham.DanhMuc
WHERE SOLUONG>0
GROUP BY DANHMUC.TEN 
SELECT * FROM CHITIETSANPHAM

CREATE TRIGGER HUYVESL ON CHITIETHOADON AFTER UPDATE AS
BEGIN 
	IF (SELECT INSERTED.TRANGTHAI FROM CHITIETHOADON JOIN INSERTED ON CHITIETHOADON.ID=INSERTED.ID)=0
	BEGIN
	UPDATE ChiTietSanPham SET SOLUONG+=INSERTED.SOLUONG
	FROM ChiTietSanPham JOIN INSERTED ON CHITIETSANPHAM.ID=INSERTED.IDCTSP
	END
END
SELECT * FROM KHACHHANG
ALTER TRIGGER UDCTHDHUY ON HOADON AFTER UPDATE AS
BEGIN
	IF(SELECT INSERTED.TRANGTHAI FROM inserted join hoadon on HOADON.ID=INSERTED.ID)=2
	BEGIN
	UPDATE CHITIETHOADON SET TRANGTHAI=0
	FROM CHITIETHOADON JOIN INSERTED ON CHITIETHOADON.IDHD=INSERTED.ID
	WHERE CHITIETHOADON.ID in(SELECT CHITIETHOADON.ID FROM CHITIETHOADON JOIN INSERTED ON CHITIETHOADON.IDHD= INSERTED.ID)
	END
END
UPDATE ChiTietHoaDon SET TrangThai=2 WHERE ID IN (SELECT CHITIETHOADON.ID FROM ChiTietHoaDon JOIN HOADON ON HOADON.ID=ChiTietHoaDon.IDHD WHERE IDHD='E28A685C-6E56-4096-9963-644D0EF8A550')
select * from chitiethoadon join hoadon on hoadon.id=ChiTietHoaDon.idhd where mahd='HD11'
UPDATE ChiTietHoaDon SET TRANGTHAI=0 WHERE ID='C0E2CE92-68C8-4087-BED9-88BCE9C1E9E8'
UPDATE HOADON SET TRANGTHAI=2 WHERE MAHD='HD11'
select * from ChiTietHoaDon
SELECT * FROM HoaDon
SELECT * FROM ChiTietSanPham WHERE ID='44342788-2E26-4883-A242-F2B7484B30EB'
SELECT * FROM HoaDon WHERE ID='86698180-F234-484C-AA25-BAAC0405D771'
SELECT ChiTietHoaDon.ID AS CTHD,ChiTietSanPham.ID AS CTSP,ChiTietSanPham.DanhMuc,ChiTietHoaDon.SoLuong AS SL FROM ChiTietHoaDon Join chiTietSanPham 
	on ChiTietHoaDon.idctsp=ChiTietSanPham.id
	JOIN HOADON ON HOADON.ID=ChiTietHoaDon.IDHD
	WHERE HOADON.TrangThai=1
	SELECT * FROM DANHMUC
SELECT * FROM HoaDon
SELECT ChiTietHoaDon.ID,ChiTietSanPham.ID,ChiTietHoaDon.SoLuong FROM ChiTietHoaDon Join chiTietSanPham on ChiTietHoaDon.idctsp=ChiTietSanPham.id
WHERE IDHD='F802FA5F-BEF1-44E9-B875-01A09467698F'
UPDATE HOADON SET TRANGTHAI=2,GHICHU='THU huy' WHERE MAHD='HD29'
SELECT * FROM ChiTietSanPham where id='44342788-2E26-4883-A242-F2B7484B30EB'

 select * from HoaDon
 SELECT  iif( KHACHHANG.TENKH is null,N'khách lẻ',khachhang.tenkh)AS TEN , 
  iif (Khachhang.diachi ,'NULL',khachhang.diachi)AS DIACHI, 
  iif(Khachhang.sdt ,'NULL',khachhang.sdt)AS SDT
 FROM HOADON JOIN KHACHHANG ON HOADON.IDKH=KHACHHANG.ID WHERE MAHD='HD19'


